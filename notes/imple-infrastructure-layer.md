---
name: imple-infrastructure-layer
description: 在fastapi-clean-example项目中实现基础设施层时使用此技能。专注于实现端口、适应外部系统，并遵循项目特定的依赖规则。
---

# imple-infrastructure-layer 技能

本技能提供了在 `fastapi-clean-example` 项目中实现和测试基础设施层的指南。

# 何时激活

- 为领域层或应用层端口实现具体的适配器。
- 与数据库、消息队列或外部 API 等外部系统集成。
- 开发或修改持久化机制（例如，SQLAlchemy 仓库）。
- 实现与外部系统交互或提供具体服务的身份验证和授权机制。
- 修复与数据访问、外部服务调用或接口的具体实现相关的错误。
- 为基础设施组件添加测试。

## 1. 基础设施层的核心原则

### A. 适配核心到外部系统
- 基础设施层负责连接核心（领域层和应用层）与外部世界。
- 它包含“被驱动适配器”，这些适配器实现了领域层和应用层定义的端口，从而使核心与实现细节解耦。
- 它也可能包含“驱动适配器”（在本项目中通常是表示层的一部分，但在概念上相关），这些适配器将外部请求转换为对应用层的调用。

### B. 依赖规则的遵循（项目特定解释）
- 基础设施层是一个外层，**可以依赖**内层（应用层和领域层）。它**不得被**领域层或应用层直接依赖。
- **关键是，项目修订后的依赖规则指出**：“**核心内部**的依赖关系绝不能指向外部。”这意味着基础设施层作为核心之外的“桥梁”，可以与外部组件和内部层进行交互。
- 它通过实现领域层和应用层定义的接口（端口）来遵循依赖倒置原则。

### C. 技术和框架的特异性
- 这一层使用外部框架、库和技术（例如，SQLAlchemy、FastAPI 特定功能、bcrypt）来提供具体实现。
- 它封装了这些外部组件的细节，保护内层免受其具体影响。

## 2. 基础设施层组件的实现

### A. 通用实现指南
- **端口实现**：大多数基础设施组件的主要目标是为领域层和应用层中定义的端口（接口）提供具体实现。
- **外部细节封装**：所有与外部框架、数据库或第三方 API 的交互都应封装在这一层中。内层应只与抽象（端口）交互。
- **数据映射**：基础设施组件负责在核心的数据结构（例如，领域实体、应用 DTO）与外部系统所需的数据结构（例如，ORM 模型、API 请求/响应格式）之间进行映射。
- **错误转换**：基础设施特定的错误（例如，数据库连接错误、API 速率限制）应在适当的情况下转换为更通用或领域特定的异常，尤其是在传播到应用层时。

### B. 适配器 (`src/app/infrastructure/adapters/`)
- **目的**：实现领域层或应用层中定义的 `typing.Protocol` 或 `abc.ABC` 接口（端口）。这些适配器通过与外部系统交互提供具体功能。
- **实现**：
    - 每个适配器应实现一个特定的端口。
    - 示例包括 `password_hasher_bcrypt.py`（实现领域层的 `PasswordHasher`）、`user_id_generator_uuid.py`（实现领域层的 `UserIdGenerator`）和 `user_data_mapper_sqla.py`（用于持久化）。
    - 领域/应用模型与基础设施特定模型（例如，SQLAlchemy ORM 模型）之间的数据映射是这里的一个关键职责。
- **示例**：`src/app/infrastructure/adapters/password_hasher_bcrypt.py`

### C. 持久化 (`src/app/infrastructure/persistence_sqla/`)
- **目的**：使用 SQLAlchemy 处理所有数据库交互。这包括定义 ORM 模型、仓库实现和事务管理。
- **实现**：
    - 定义表示数据存储结构的 SQLAlchemy 模型。
    - 实现执行 CRUD 操作和数据查询的具体仓库，并在 SQLAlchemy 模型和领域/应用实体/查询模型之间进行转换。
    - 利用 SQLAlchemy 的特性进行高效的数据访问和事务管理。

### D. 身份验证（示例） (`src/app/infrastructure/auth/`)
- **目的**：本节作为一个示例，说明如何将身份验证等横切关注点在基础设施层中实现。它为身份验证和授权提供具体的服务，例如会话管理和 JWT 处理。
- **实现**：
    - 此部分处理令牌生成、验证、会话存储和检索的具体细节，展示了封装外部细节和提供具体服务的通用指南。
    - 它可能会暴露处理程序（如 `README.md` 中“基础设施控制器 - 处理程序”部分所述），这些处理程序虽然位于基础设施层，但其操作方式类似于应用层处理程序，但与本项目中被视为基础设施细节的“身份验证上下文”紧密相关。

### E. 异常 (`src/app/infrastructure/exceptions/`)
- **目的**：定义和处理基础设施特有的异常，并在必要时将其转换为领域特定异常。
- **实现**：
    - 基础设施异常可能源于数据库错误、外部 API 故障或配置问题。
    - 在某些情况下（例如，`UNIQUE CONSTRAINT` 违规在数据库中），可能适合抛出领域特定异常（如 `UsernameAlreadyExistsError`），由应用层处理，以确保业务逻辑控制。

## 3. 基础设施层的单元测试 (`tests/app/unit/infrastructure/`)

- **位置**：基础设施层的所有单元测试都位于 `tests/app/unit/infrastructure/` 中。子目录应与 `src/app/infrastructure/` 的结构保持一致。
- **框架**：使用 `pytest` 和 `pytest-asyncio`。
- **隔离**：
    - 基础设施组件（特别是适配器）应隔离测试。
    - 测试与外部系统（例如数据库或外部 API）交互的适配器时，**模拟**外部依赖项，以确保测试仅关注适配器的逻辑。对于持久化，这可能涉及使用内存数据库或模拟 SQLAlchemy 会话。
- **测试数据**：利用测试数据工厂生成一致且可重用的测试数据，类似于其他层。
- **端口实现验证**：确保基础设施适配器正确实现了领域层和应用层定义的契约（端口）。
- **错误处理**：测试基础设施组件是否正确处理来自外部系统的错误并抛出适当的（或转换后的）异常。
- **全面场景**：编写测试覆盖：
    - 与模拟外部系统的成功交互。
    - 基础设施组件的边缘情况和失败场景。
    - 正确的数据映射和转换。
- **集成测试 (`tests/app/integration/`)**：对于涉及多个基础设施组件或实际外部系统（例如真实数据库）的更复杂交互，应在 `tests/app/integration/` 中编写集成测试。

## 4. 接口和跨层引用

### A. 实现端口
- 基础设施层在接口方面的主要作用是**实现**在 `src/app/domain/ports/` 和 `src/app/application/common/ports/` 中定义的端口（`typing.Protocol` 或 `abc.ABC`）。

### B. 基础设施层的允许引用
- 基础设施层**可以引用**：
    - 应用层内的组件（例如，DTO、查询模型）。
    - 领域层内的组件（例如，实体、值对象、枚举、异常）。
    - 标准 Python 库模块。
    - 针对其实现关注点的外部库和框架（例如，SQLAlchemy、bcrypt、`uuid`、`fastapi`）。
    - 基础设施层内的其他组件。
- 基础设施层**不应被**领域层或应用层引用。禁止从内层到外层的直接依赖。